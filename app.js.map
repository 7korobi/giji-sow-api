{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///external \"express\"","webpack:///./api/base.coffee","webpack:///external \"body-parser\"","webpack:///external \"morgan\"","webpack:///./api/mongodb.coffee","webpack:///external \"mongodb-bluebird\"","webpack:///external \"child_process\"","webpack:///./api/index.coffee","webpack:///external \"config\"","webpack:///external \"debug\""],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","bodyParser","logger","app","conf","use","json","req","res","next","header","_","fs","giji","mongo","sh","url","db","mongo_sow","connect","then","err","console","log","find","id","query","projection","collection","ObjectId","aggregate_message","cmd","firsts","out","keys","ext","remove","aggregate","$sort","date_min","$group","_id","date","$min","$out","data","Promise","all","map","face_id","mestype","story_id","q","data_size","length","insert","date_max","$max","max","$sum","count","story_ids","$addToSet","sow_auth_id","aggregate_potof","$match","$exists","$nin","$ne","is_finish","live","role_id","$unwind","aggregate_max","$project","$size","_id.face_id","list","top","sortBy","a","oldlog","$eq","dst","src","results","len","ref","api","push","writeFile","join","error","chmod","exec","stdout","stderr","scan","set_bases","set_base","logid","size","$strLenCP","$substr","catch","started","e","m_faces","faces","sow_auths","params","mestypes","roles","lives","limit","Date","write_at","$gte","state","$in","plans","fields","is_epilogue","comment","password","stories","ids","events","messages","potofs","host","pm_id","port","express","process","env","assign","on","dir","use_api","set","listen"],"mappings":"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","file":"app.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 9);\n","module.exports = require(\"fs\");","module.exports = require(\"lodash\");","module.exports = require(\"express\");","bodyParser = require 'body-parser'\nlogger = require 'morgan'\n\nmodule.exports = (app, conf)->\n  app.use logger 'dev'\n  app.use bodyParser.json()\n  app.use (req, res, next)->\n    res.header \"Access-Control-Allow-Origin\", \"*\"\n    res.header \"Access-Control-Allow-Headers\", \"Origin, X-Requested-With, Content-Type, Accept\"\n    next()\n","module.exports = require(\"body-parser\");","module.exports = require(\"morgan\");","mongo = require \"mongodb-bluebird\"\nsh = require 'child_process'\nfs = require 'fs'\n_ = require \"lodash\"\n\nObjectId = false\n\ngiji = {}\n\nmodule.exports = (app, { url, db })->\n  return unless db.mongo_sow\n  mongo.connect db.mongo_sow\n  .then (db)->\n    end = (err, o)->\n      console.log err, o\n    giji.find = (id, query, projection)->\n      db.collection id, {ObjectId}\n      .find query, projection\n\n    giji.aggregate_message = ->\n      firsts = (out, keys, ext...)->\n        db.collection(out, { ObjectId }).remove({})\n        .then ->\n          db.collection(\"message_by_story_for_face\", {ObjectId}).aggregate [\n            $sort:\n              date_min: 1\n          ,\n            $group:\n              _id: keys\n              date:\n                $min: \"$date_min\"\n          ,\n            $out: \"#{out}_date_mins\"\n          ], {ObjectId}\n        .then (data)->\n          Promise.all data.map ({ _id, date })->\n            { story_id, face_id, mestype } = _id\n            console.log { c: 'messages', story_id, face_id, date }\n            db.collection(\"messags\", {ObjectId})\n            .find({ story_id, face_id, date })\n            .then (o)->\n              o.q = _id\n              o\n        .then (data)->\n          console.log { out, keys, ext, data_size: data.length }\n          if data.length\n            db.collection(out, { ObjectId }).insert data\n\n      cmd = (out, keys, ext...)->\n        db.collection(\"message_by_story_for_face\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$date_min\"\n            date_max:\n              $max: \"$date_max\"\n            max:\n              $max: \"$max\"\n            all:\n              $sum: \"$all\"\n            count:\n              $sum: \"$count\"\n            story_ids:\n              $addToSet: \"$_id.story_id\"\n        ,\n          $out: out\n        ], {ObjectId}\n      Promise.all [\n        cmd \"message_for_face\",\n          face_id: \"$_id.face_id\"\n        cmd \"message_for_face_sow_auth\",\n          face_id:     \"$_id.face_id\"\n          sow_auth_id: \"$_id.sow_auth_id\"\n        cmd \"message_for_face_mestype\",\n          face_id: \"$_id.face_id\"\n          mestype: \"$_id.mestype\"\n        firsts \"message_firsts_for_story_face_mestype\",\n          story_id: \"$_id.story_id\"\n          face_id:  \"$_id.face_id\"\n          mestype:  \"$_id.mestype\"\n      ]\n\n\n    giji.aggregate_potof = ->\n      cmd = (out, story_ids, keys, ext...)->\n        db.collection(\"potofs\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $match:\n            story_id:\n              $exists: 1\n              $nin: story_ids\n            sow_auth_id:\n              $exists: 1\n              $nin: [null, \"master\", \"admin\", \"a1\", \"a2\", \"a3\", \"a4\", \"a5\", \"a6\", \"a7\", \"a8\", \"a9\"]\n            face_id:\n              $exists: 1\n              $ne: null\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$timer.entrieddt\"\n            date_max:\n              $max: \"$timer.entrieddt\"\n            story_ids:\n              $addToSet: \"$story_id\"\n\n        ,\n          $out: out\n        ], {ObjectId}\n        .then ->\n          console.log { out, keys, ext, story_ids }\n\n      giji.find \"stories\", { is_finish: false }, { _id: 1 }\n      .then (data)->\n        story_ids = data.map ({ _id })-> _id\n        console.log story_ids, \"is progress (deny).\"\n        Promise.all [\n          cmd \"potof_for_face\", story_ids,\n            face_id: \"$face_id\"\n          cmd \"potof_for_face_live\", story_ids,\n            face_id: \"$face_id\"\n            live: \"$live\"\n          cmd \"potof_for_face_sow_auth\", story_ids,\n            face_id:     \"$face_id\"\n            sow_auth_id: \"$sow_auth_id\"\n          cmd \"potof_for_face_role\", story_ids,\n            face_id: \"$face_id\"\n            role_id: \"$role\"\n          ,\n            $unwind: \"$role\"\n        ]\n\n    giji.aggregate_max = ->\n      db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).remove({})\n      .then ->\n        db.collection(\"potof_for_face_sow_auth\", { ObjectId }).aggregate [\n          $project:\n            _id: 1\n            count:\n              $size: \"$story_ids\"\n        ,\n          $group:\n            _id:\n              face_id: \"$_id.face_id\"\n            count:\n              $max: \"$count\"\n        ], {ObjectId}\n      .then (data)->\n        Promise.all data.map (o)->\n          giji.find \"potof_for_face_sow_auth\",\n            \"_id.face_id\": o._id.face_id\n            story_ids:\n              $size: o.count\n          .then (list)->\n            [top] = _.sortBy list, (a)-> a.date_min\n            o.date_min = top.date_min\n            o.date_max = top.date_max\n            o._id      = top._id\n            o\n      .then (data)->\n        console.log \"potof_for_face_sow_auth_max insert #{data.length} data.\"\n        db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).insert data\n\n    giji.oldlog = ->\n      db.collection(\"stories\", { ObjectId }).aggregate [\n        $match:\n          is_finish:\n            $eq: true\n      ,\n        $project:\n          _id: 1\n      ,\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id\"\n      ], {ObjectId}\n      .then ([o])->\n        data = for id in o.story_ids\n          dst = \"./static/sow/#{id}.json.gz\"\n          src = \"#{url.api}/story/oldlog/#{id}\"\n          \"\"\"  ls \"#{dst}\" || curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/sow/index.json.gz\"\n        src = \"#{url.api}/story/oldlog\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/aggregate/faces/index.json.gz\"\n        src = \"#{url.api}/aggregate/faces\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        data.push \"\"\" npm run gulp amazon:gz \"\"\"\n\n        fs.writeFile './static/sow.sh', data.join(\"\\n\") , (err)->\n          if err\n            console.error err\n          else\n            console.log \"write.\"\n            fs.chmod './static/sow.sh', 0o777, (err)->\n              if err\n                console.error err\n              else\n                console.log \"chmod.\"\n                sh.exec \"./static/sow.sh\", (err, stdout, stderr)->\n                  if err\n                    console.error err\n                  else\n                    console.log stderr\n        false\n\n    giji.scan = ->\n      db.collection(\"message_by_story_for_face\", { ObjectId }).aggregate [\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id.story_id\"\n      ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        db.collection(\"stories\", { ObjectId }).aggregate [\n          $match:\n            _id:\n              $nin: list\n            is_finish:\n              $eq: true\n        ,\n          $project:\n            _id: 1\n        ,\n          $group:\n            _id: null\n            story_ids:\n              $addToSet: \"$_id\"\n        ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        console.log \"step B\"\n        console.log list\n        set_bases = for id in list\n          giji.set_base id\n        Promise.all set_bases\n\n    giji.set_base = (story_id)->\n      console.log \"step for #{story_id}\"\n      db.collection(\"messages\", { ObjectId }).aggregate [\n        $match:\n          story_id: story_id\n          sow_auth_id:\n            $exists: 1\n            $ne: null\n          face_id:\n            $exists: 1\n            $ne: null\n          logid:\n            $exists: 1\n            $ne: null\n          log:\n            $exists: 1\n            $ne: null\n      ,\n        $project:\n          sow_auth_id: 1\n          story_id: 1\n          face_id: 1\n          logid: 1\n          date: 1\n          size:\n            $strLenCP: \"$log\"\n      ,\n        $group:\n          _id:\n            sow_auth_id: \"$sow_auth_id\"\n            story_id: \"$story_id\"\n            face_id: \"$face_id\"\n            mestype:\n              $substr: [\"$logid\", 0, 2]\n          date_min:\n            $min: \"$date\"\n          date_max:\n            $max: \"$date\"\n          max:\n            $max: \"$size\"\n          all:\n            $sum: \"$size\"\n          count:\n            $sum: 1\n      ], {ObjectId}\n      .then (data)->\n        if data.length\n          db.collection(\"message_by_story_for_face\").insert data\n        else\n          console.log \"#{story_id} for message_by_story_for_face size 0.\"\n  .catch ->\n    console.log \"!!! mongodb connect error !!!\"\n\n\n  app.get '/api/aggregate/job', (req, res, next)->\n    giji.scan()\n    .then ->\n      giji.aggregate_message()\n    .then ->\n      giji.aggregate_potof()\n    .then ->\n      giji.aggregate_max()\n    .then ->\n      giji.oldlog()\n    .then ->\n      res.json\n        started: true\n      next()\n    .catch (e)->\n      res.json e\n      next()\n\n  app.get '/api/aggregate/faces', (req, res, next)->\n    q = {}\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_sow_auth_max\", q\n    ]\n    .then ([m_faces, faces, sow_auths])->\n      res.json { m_faces, faces, sow_auths }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/aggregate/faces/:id', (req, res, next)->\n    { id } = req.params\n    q =\n      \"_id.face_id\": id\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"message_for_face_mestype\", q\n      giji.find \"message_for_face_sow_auth\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_role\", q\n      giji.find \"potof_for_face_live\", q\n    ]\n    .then ([m_faces, mestypes, sow_auths, faces, roles, lives])->\n      res.json { m_faces, mestypes, sow_auths, faces, roles, lives }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n\n  app.get '/api/plan/progress', (req, res, next)->\n    range = 1000 * 3600 * 24 * 50 # 50 days\n    limit = new Date( new Date() - range )\n\n    giji.find \"sow_village_plans\",\n      write_at:\n        $gte: limit\n      state:\n        $in: [\n          null\n          /議事/\n        ]\n    .then (data)->\n      res.json { plans: data }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/progress', (req, res, next)->\n    q =\n      is_epilogue: false\n      is_finish: false\n    fields =\n      comment:  0\n      password: 0\n    json = {}\n    giji.find \"stories\", q, fields\n    .then (data)->\n      json.stories = data\n      data.map (o)-> \"#{o._id}-0\"\n    .then (ids)->\n      giji.find \"events\",\n        _id:\n          $in: ids\n    .then (data)->\n      json.events = data\n    .then ->\n      res.json json\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog', (req, res, next)->\n    q =\n      is_epilogue: true\n      is_finish:   true\n    fields =\n      comment:  0\n      password: 0\n    Promise.all [\n      giji.find \"stories\", q, fields\n      giji.find \"potof_for_face\", {}\n    ]\n    .then ([stories, faces])->\n      res.json { stories, faces }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog/:story_id', (req, res, next)->\n    { story_id } = req.params\n    fields =\n      password: 0\n    Promise.all [\n      giji.find \"stories\",  { _id: story_id, is_epilogue: true, is_finish: true}, fields\n      giji.find \"messages\", { story_id }\n      giji.find \"events\",   { story_id }\n      giji.find \"potofs\",   { story_id }\n    ]\n    .then ([stories, messages, events, potofs])->\n      unless stories.length\n        messages = events = potofs = []\n      res.json { stories, messages, events, potofs }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  return\n","module.exports = require(\"mongodb-bluebird\");","module.exports = require(\"child_process\");","express = require 'express'\napp = express()\nconf = require 'config'\ndebug = require('debug')('giji-sow-api:server')\n\n{ pm_id } = process.env\nObject.assign conf, { pm_id }\nprocess.on 'unhandledRejection', console.dir\n\n\nrequire(\"./base.coffee\")(app, conf)\nif conf.use_api\n  # for only legacy jinrogiji\n  require(\"./mongodb.coffee\" )(app, conf)\n\nhost = ( conf.host || '127.0.0.1' )\nport = ( conf.port || 4000 ) + (pm_id - 0 || 0)\n\napp.set 'port', port\napp.listen port, host\nconsole.log(\"Server is listening on http://#{host}:#{port}\")\n\n# var indexRouter = require('./routes/index')\n# var usersRouter = require('./routes/users')\n# app.use('/', indexRouter)\n# app.use('/users', usersRouter)\n","module.exports = require(\"config\");","module.exports = require(\"debug\");"],"sourceRoot":""}