{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///external \"express\"","webpack:///./api/base.coffee","webpack:///external \"body-parser\"","webpack:///external \"morgan\"","webpack:///./api/mongodb.coffee","webpack:///external \"mongodb-bluebird\"","webpack:///external \"child_process\"","webpack:///./spec/index.coffee","webpack:///external \"ava\"","webpack:///external \"supertest\"","webpack:///external \"js-yaml\"","webpack:///./spec/user.coffee","webpack:///./spec/book.coffee","webpack:///./spec/chat.coffee"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","bodyParser","logger","app","conf","use","json","req","res","next","header","mongo","sh","fs","_","giji","url","db","mongo_sow","connect","then","err","console","log","find","id","query","projection","collection","ObjectId","aggregate_message","firsts","out","keys","ext","remove","aggregate","$sort","date_min","$group","_id","date","$min","$out","data","Promise","all","map","story_id","face_id","mestype","q","data_size","length","insert","cmd","date_max","$max","max","$sum","count","story_ids","$addToSet","sow_auth_id","aggregate_potof","$match","$exists","$nin","$ne","is_finish","live","role_id","$unwind","aggregate_max","$project","$size","list","top","sortBy","a","oldlog","$eq","dst","src","api","push","writeFile","join","error","chmod","exec","stdout","stderr","scan","set_bases","set_base","logid","size","$strLenCP","$substr","catch","started","e","m_faces","faces","sow_auths","params","mestypes","roles","lives","limit","Date","write_at","$gte","state","$in","plans","is_epilogue","fields","comment","password","stories","ids","events","messages","potofs","test","express","supertest","load","readFileSync","user","provider","icon","mail","nick","sign","token","account","bless","match","tgt","chk","result","index","input","deepEqual","deepContain","mergeWith","constructor","Array","post","passport","session","http","agent","serial","text","send","JSON","parse","message","redirect","location","is","book","potof","label","chat","interval","night","player","mob","game","vote","vote_by","tag_ids","option","job","chats","idx","part","type","phases","handle","update","stats","cards","parts","phase_id","stat","give","sw","card"],"mappings":"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","file":"spec.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 12);\n","module.exports = require(\"fs\");","module.exports = require(\"lodash\");","module.exports = require(\"express\");","bodyParser = require 'body-parser'\nlogger = require 'morgan'\n\nmodule.exports = (app, conf)->\n  app.use logger 'dev'\n  app.use bodyParser.json()\n  app.use (req, res, next)->\n    res.header \"Access-Control-Allow-Origin\", \"*\"\n    res.header \"Access-Control-Allow-Headers\", \"Origin, X-Requested-With, Content-Type, Accept\"\n    next()\n","module.exports = require(\"body-parser\");","module.exports = require(\"morgan\");","mongo = require \"mongodb-bluebird\"\nsh = require 'child_process'\nfs = require 'fs'\n_ = require \"lodash\"\n\nObjectId = false\n\ngiji = {}\n\nmodule.exports = (app, { url, db })->\n  return unless db.mongo_sow\n  mongo.connect db.mongo_sow\n  .then (db)->\n    end = (err, o)->\n      console.log err, o\n    giji.find = (id, query, projection)->\n      db.collection id, {ObjectId}\n      .find query, projection\n\n    giji.aggregate_message = ->\n      firsts = (out, keys, ext...)->\n        db.collection(out, { ObjectId }).remove({})\n        .then ->\n          db.collection(\"message_by_story_for_face\", {ObjectId}).aggregate [\n            $sort:\n              date_min: 1\n          ,\n            $group:\n              _id: keys\n              date:\n                $min: \"$date_min\"\n          ,\n            $out: \"#{out}_date_mins\"\n          ], {ObjectId}\n        .then (data)->\n          Promise.all data.map ({ _id, date })->\n            { story_id, face_id, mestype } = _id\n            console.log { c: 'messages', story_id, face_id, date }\n            db.collection(\"messags\", {ObjectId})\n            .find({ story_id, face_id, date })\n            .then (o)->\n              o.q = _id\n              o\n        .then (data)->\n          console.log { out, keys, ext, data_size: data.length }\n          if data.length\n            db.collection(out, { ObjectId }).insert data\n\n      cmd = (out, keys, ext...)->\n        db.collection(\"message_by_story_for_face\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$date_min\"\n            date_max:\n              $max: \"$date_max\"\n            max:\n              $max: \"$max\"\n            all:\n              $sum: \"$all\"\n            count:\n              $sum: \"$count\"\n            story_ids:\n              $addToSet: \"$_id.story_id\"\n        ,\n          $out: out\n        ], {ObjectId}\n      Promise.all [\n        cmd \"message_for_face\",\n          face_id: \"$_id.face_id\"\n        cmd \"message_for_face_sow_auth\",\n          face_id:     \"$_id.face_id\"\n          sow_auth_id: \"$_id.sow_auth_id\"\n        cmd \"message_for_face_mestype\",\n          face_id: \"$_id.face_id\"\n          mestype: \"$_id.mestype\"\n        firsts \"message_firsts_for_story_face_mestype\",\n          story_id: \"$_id.story_id\"\n          face_id:  \"$_id.face_id\"\n          mestype:  \"$_id.mestype\"\n      ]\n\n\n    giji.aggregate_potof = ->\n      cmd = (out, story_ids, keys, ext...)->\n        db.collection(\"potofs\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $match:\n            story_id:\n              $exists: 1\n              $nin: story_ids\n            sow_auth_id:\n              $exists: 1\n              $nin: [null, \"master\", \"admin\", \"a1\", \"a2\", \"a3\", \"a4\", \"a5\", \"a6\", \"a7\", \"a8\", \"a9\"]\n            face_id:\n              $exists: 1\n              $ne: null\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$timer.entrieddt\"\n            date_max:\n              $max: \"$timer.entrieddt\"\n            story_ids:\n              $addToSet: \"$story_id\"\n\n        ,\n          $out: out\n        ], {ObjectId}\n        .then ->\n          console.log { out, keys, ext, story_ids }\n\n      giji.find \"stories\", { is_finish: false }, { _id: 1 }\n      .then (data)->\n        story_ids = data.map ({ _id })-> _id\n        console.log story_ids, \"is progress (deny).\"\n        Promise.all [\n          cmd \"potof_for_face\", story_ids,\n            face_id: \"$face_id\"\n          cmd \"potof_for_face_live\", story_ids,\n            face_id: \"$face_id\"\n            live: \"$live\"\n          cmd \"potof_for_face_sow_auth\", story_ids,\n            face_id:     \"$face_id\"\n            sow_auth_id: \"$sow_auth_id\"\n          cmd \"potof_for_face_role\", story_ids,\n            face_id: \"$face_id\"\n            role_id: \"$role\"\n          ,\n            $unwind: \"$role\"\n        ]\n\n    giji.aggregate_max = ->\n      db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).remove({})\n      .then ->\n        db.collection(\"potof_for_face_sow_auth\", { ObjectId }).aggregate [\n          $project:\n            _id: 1\n            count:\n              $size: \"$story_ids\"\n        ,\n          $group:\n            _id:\n              face_id: \"$_id.face_id\"\n            count:\n              $max: \"$count\"\n        ], {ObjectId}\n      .then (data)->\n        Promise.all data.map (o)->\n          giji.find \"potof_for_face_sow_auth\",\n            \"_id.face_id\": o._id.face_id\n            story_ids:\n              $size: o.count\n          .then (list)->\n            [top] = _.sortBy list, (a)-> a.date_min\n            o.date_min = top.date_min\n            o.date_max = top.date_max\n            o._id      = top._id\n            o\n      .then (data)->\n        console.log \"potof_for_face_sow_auth_max insert #{data.length} data.\"\n        db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).insert data\n\n    giji.oldlog = ->\n      db.collection(\"stories\", { ObjectId }).aggregate [\n        $match:\n          is_finish:\n            $eq: true\n      ,\n        $project:\n          _id: 1\n      ,\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id\"\n      ], {ObjectId}\n      .then ([o])->\n        data = for id in o.story_ids\n          dst = \"./static/sow/#{id}.json.gz\"\n          src = \"#{url.api}/story/oldlog/#{id}\"\n          \"\"\"  ls \"#{dst}\" || curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/sow/index.json.gz\"\n        src = \"#{url.api}/story/oldlog\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/aggregate/faces/index.json.gz\"\n        src = \"#{url.api}/aggregate/faces\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        data.push \"\"\" npm run gulp amazon_gz \"\"\"\n\n        fs.writeFile './static/sow.sh', data.join(\"\\n\") , (err)->\n          if err\n            console.error err\n          else\n            console.log \"write.\"\n            fs.chmod './static/sow.sh', 0o777, (err)->\n              if err\n                console.error err\n              else\n                console.log \"chmod.\"\n                sh.exec \"./static/sow.sh\", (err, stdout, stderr)->\n                  if err\n                    console.error err\n                  else\n                    console.log stderr\n        false\n\n    giji.scan = ->\n      db.collection(\"message_by_story_for_face\", { ObjectId }).aggregate [\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id.story_id\"\n      ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        db.collection(\"stories\", { ObjectId }).aggregate [\n          $match:\n            _id:\n              $nin: list\n            is_finish:\n              $eq: true\n        ,\n          $project:\n            _id: 1\n        ,\n          $group:\n            _id: null\n            story_ids:\n              $addToSet: \"$_id\"\n        ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        console.log \"step B\"\n        console.log list\n        set_bases = for id in list\n          giji.set_base id\n        Promise.all set_bases\n\n    giji.set_base = (story_id)->\n      console.log \"step for #{story_id}\"\n      db.collection(\"messages\", { ObjectId }).aggregate [\n        $match:\n          story_id: story_id\n          sow_auth_id:\n            $exists: 1\n            $ne: null\n          face_id:\n            $exists: 1\n            $ne: null\n          logid:\n            $exists: 1\n            $ne: null\n          log:\n            $exists: 1\n            $ne: null\n      ,\n        $project:\n          sow_auth_id: 1\n          story_id: 1\n          face_id: 1\n          logid: 1\n          date: 1\n          size:\n            $strLenCP: \"$log\"\n      ,\n        $group:\n          _id:\n            sow_auth_id: \"$sow_auth_id\"\n            story_id: \"$story_id\"\n            face_id: \"$face_id\"\n            mestype:\n              $substr: [\"$logid\", 0, 2]\n          date_min:\n            $min: \"$date\"\n          date_max:\n            $max: \"$date\"\n          max:\n            $max: \"$size\"\n          all:\n            $sum: \"$size\"\n          count:\n            $sum: 1\n      ], {ObjectId}\n      .then (data)->\n        if data.length\n          db.collection(\"message_by_story_for_face\").insert data\n        else\n          console.log \"#{story_id} for message_by_story_for_face size 0.\"\n  .catch ->\n    console.log \"!!! mongodb connect error !!!\"\n\n\n  app.get '/api/aggregate/job', (req, res, next)->\n    giji.scan()\n    .then ->\n      giji.aggregate_message()\n    .then ->\n      giji.aggregate_potof()\n    .then ->\n      giji.aggregate_max()\n    .then ->\n      giji.oldlog()\n    .then ->\n      res.json\n        started: true\n      next()\n    .catch (e)->\n      res.json e\n      next()\n\n  app.get '/api/aggregate/faces', (req, res, next)->\n    q = {}\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_sow_auth_max\", q\n    ]\n    .then ([m_faces, faces, sow_auths])->\n      res.json { m_faces, faces, sow_auths }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/aggregate/faces/:id', (req, res, next)->\n    { id } = req.params\n    q =\n      \"_id.face_id\": id\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"message_for_face_mestype\", q\n      giji.find \"message_for_face_sow_auth\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_role\", q\n      giji.find \"potof_for_face_live\", q\n    ]\n    .then ([m_faces, mestypes, sow_auths, faces, roles, lives])->\n      res.json { m_faces, mestypes, sow_auths, faces, roles, lives }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n\n  app.get '/api/plan/progress', (req, res, next)->\n    range = 1000 * 3600 * 24 * 50 # 50 days\n    limit = new Date( new Date() - range )\n\n    giji.find \"sow_village_plans\",\n      write_at:\n        $gte: limit\n      state:\n        $in: [\n          null\n          /議事/\n        ]\n    .then (data)->\n      res.json { plans: data }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/progress', (req, res, next)->\n    q =\n      is_epilogue: false\n      is_finish: false\n    fields =\n      comment:  0\n      password: 0\n    json = {}\n    giji.find \"stories\", q, fields\n    .then (data)->\n      json.stories = data\n      data.map (o)-> \"#{o._id}-0\"\n    .then (ids)->\n      giji.find \"events\",\n        _id:\n          $in: ids\n    .then (data)->\n      json.events = data\n    .then ->\n      res.json json\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog', (req, res, next)->\n    q =\n      is_epilogue: true\n      is_finish:   true\n    fields =\n      comment:  0\n      password: 0\n    Promise.all [\n      giji.find \"stories\", q, fields\n      giji.find \"potof_for_face\", {}\n    ]\n    .then ([stories, faces])->\n      res.json { stories, faces }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog/:story_id', (req, res, next)->\n    { story_id } = req.params\n    fields =\n      password: 0\n    Promise.all [\n      giji.find \"stories\",  { _id: story_id, is_epilogue: true, is_finish: true}, fields\n      giji.find \"messages\", { story_id }\n      giji.find \"events\",   { story_id }\n      giji.find \"potofs\",   { story_id }\n    ]\n    .then ([stories, messages, events, potofs])->\n      unless stories.length\n        messages = events = potofs = []\n      res.json { stories, messages, events, potofs }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  return\n","module.exports = require(\"mongodb-bluebird\");","module.exports = require(\"child_process\");","test = require 'ava'\nexpress = require 'express'\nsupertest = require 'supertest'\n\nfs = require 'fs'\nyaml = require 'js-yaml'\n\n\nconf = yaml.load fs.readFileSync \"./config/spec.yml\", 'UTF-8'\n\nuser =\n  _id: \"local-test-user\"\n  provider: \"local-test\"\n  icon: \"https://s3-ap-northeast-1.amazonaws.com/giji-assets/images/portrate/w52.jpg\"\n  mail: \"7korobi.sys@gmail.com\"\n  nick: \"テスト中\"\n  sign: \"SIGN.SPEC\"\n  write_at: new Date - 0\n  token: \"DEADBEEF\"\n  account: \"user\"\n\n_ = require \"lodash\"\nbless = (t)->\n  t.match = (tgt, chk)->\n    result = [ tgt ]\n    result.index = 0\n    result.input = tgt\n    @deepEqual result, tgt.match chk\n\n  t.deepContain = (tgt, chk)->\n    chk = _.mergeWith chk, tgt, (c, o)->\n      switch c?.constructor\n        when null, undefined\n          o\n        when Array, Object\n          undefined\n        else\n          c\n    @deepEqual tgt, chk\n\napp = express()\nrequire(\"~/api/base\"    )(app, conf)\nrequire(\"~/api/mongodb\" )(app, conf)\n\napp.post '/test/session', (req, res, next)->\n  req.session.passport ?= {}\n  req.session.passport.user ?= user\n  res.json req.session.passport\n\nhttp = supertest.agent(app)\n\n\nrequire(\"~/spec/user\") app, { test, bless, http }\nrequire(\"~/spec/book\") app, { test, bless, http }\nrequire(\"~/spec/chat\") app, { test, bless, http }\n","module.exports = require(\"ava\");","module.exports = require(\"supertest\");","module.exports = require(\"js-yaml\");","user =\n  sign: \"公開サイン\"\n\nmodule.exports = (app, { test, http, bless })->\n  test.serial 'post api/user fail.', (t)->\n    await http.post \"/logout\"\n\n    { text } = await http\n    .post \"/api/user\"\n    .send\n      user:\n        sign: \"公開サイン\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      message: \"ログインしていません。\"\n\n  test.serial 'post api/user', (t)->\n    await http.post \"/test/session\"\n\n    { text } = await http\n    .post \"/api/user\"\n    .send { user }\n\n    bless t\n    t.deepContain JSON.parse(text), { user }\n\n  test 'get /auth/google/callback.', (t)->\n    { redirect, header: { location } } = await http.get \"/auth/google/callback\"\n\n    bless t\n    t.is redirect, true\n    t.match location, ///\n      https://accounts.google.com/o/oauth2/v2/auth\\?response_type=code&redirect_uri=http%3A%2F%2F127.0.0.1%3A\\d\\d\\d\\d\\d%2Fauth%2Fgoogle%2Fundefined%2Fauth%2Fgoogle%2Fcallback&client_id=TEST-CLIENT-ID\n    ///\n\n  test 'get /auth/facebook/callback.', (t)->\n    { redirect, header: { location } } = await http.get \"/auth/facebook/callback\"\n    \n    bless t\n    t.is redirect, true\n    t.match location, ///\n      https://www.facebook.com/dialog/oauth\\?response_type=code&redirect_uri=http%3A%2F%2F127.0.0.1%3A\\d\\d\\d\\d\\d%2Fauth%2Ffacebook%2Fundefined%2Fauth%2Ffacebook%2Fcallback&client_id=TEST-CLIENT-ID\n    ///\n","check = ->\n  book:\n    label: \"testcase\"\n    chat:\n      interval: \"1d\"\n      night:    \"0\"\n      player: 4\n      mob:    0\n    game:\n      vote: \"sign\"\n      vote_by: [\"live\"]\n    tag_ids: [\"god\", \"travel\"]\n    option: [\"vote_by_live\"]\n\n  potof:\n    _id: \"test-1-NPC\"\n    face_id: \"sf10\"\n    job: \"保安技師\"\n    sign: '公開サイン'\n  \n  chats: [\n    idx: \"welcome\"\n  ,\n    idx: \"vrule\"\n    log: \"\"\"\n1. 多重ログインをしない。\n2. システムの出力内容を、そのまま書き写さない。\n3. エピローグまで秘密を守る。参加中の村の内容は秘密だ。\n4. エピローグまで秘密を守る。希望した能力、画面を見ているきみが何者なのかは秘密だ。\n      \"\"\"\n  ]\n\n  part:\n    _id: \"test-1-1\"\n    idx: \"1\"\n    label: \"一日目\"\n\nmodule.exports = (app, { test, http, bless })->\n  test.serial 'post api/books', (t)->\n    await http.post \"/test/session\"\n\n    { book, potof } = check()\n    { text } = await http\n    .post \"/api/books\"\n    .type 'json'\n    .send { book, potof }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potof:\n        idx: \"NPC\"\n        face_id: \"sf10\"\n\n        job: \"保安技師\"\n        sign: \"公開サイン\"\n      part:\n        idx: \"0\"\n        label: \"プロローグ\"\n      phases: [\n        idx: \"BM\"\n        handle: \"MAKER\"\n        update: true\n      ,\n        idx: \"MM\"\n        handle: \"SSAY\"\n        update: true\n      ,\n        idx: \"TM\"\n        handle: \"private\"\n        update: false\n      ,\n        idx: \"SM\"\n        handle: \"public\"\n        update: false\n      ,\n        idx: \"TS\"\n        handle: \"TSAY\"\n        update: false\n      ,\n        idx: \"Aim\"\n        handle: \"AIM\"\n        update: false\n      ,\n        idx: \"SS\"\n        handle: \"SSAY\"\n        update: false\n      ,\n        idx: \"VS\"\n        handle: \"VSAY\"\n        update: false\n      ]\n      chats: [\n        idx: \"welcome\"\n      ,\n        idx: \"nrule\"\n      ,\n        idx: \"vrule\"\n      ,\n        idx: \"0\"\n      ]\n\n\n  test 'post api/books/:book_id', (t)->\n    { book, potof } = check()\n\n    { text } = await http\n    .post \"/api/books/test-1\"\n    .type 'json'\n    .send { book, potof }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potof: check().potof\n      phases: [\n        _id: \"test-1-0-BM\"\n        idx: \"BM\"\n      ,\n        _id: \"test-1-0-MM\"\n        idx: \"MM\"\n      ]\n      chats: [\n        _id: \"test-1-0-BM-welcome\"\n        idx: \"welcome\"\n      ,\n        _id: \"test-1-0-BM-nrule\"\n        idx: \"nrule\"\n      ,\n        _id: \"test-1-0-BM-vrule\"\n        idx: \"vrule\"\n      ]\n\n  test 'post api/books/:book_id/part', (t)->\n    { part } = check()\n\n    { text } = await http\n    .post \"/api/books/test-1/part\"\n    .type 'json'\n    .send { part }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      part: check().part\n      phases: [\n        idx: \"TM\"\n        handle: \"private\"\n        update: false\n      ,\n        idx: \"SM\"\n        handle: \"public\"\n        update: false\n      ,\n        idx: \"TS\"\n        handle: \"TSAY\"\n        update: false\n      ,\n        idx: \"Aim\"\n        handle: \"AIM\"\n        update: false\n      ,\n        idx: \"SS\"\n        handle: \"SSAY\"\n        update: false\n      ,\n        idx: \"VS\"\n        handle: \"VSAY\"\n        update: false\n      ]\n      chats: [\n        idx: \"0\"\n      ]\n\n\n  test 'get api/books', (t)->\n    { text } = await http\n    .get \"/api/books\"\n\n    bless t\n    for book in JSON.parse(text).books\n      t.deepContain book, check().book\n\n  test 'get api/books/:book_id', (t)->\n    { text } = await http\n    .get \"/api/books/test-1\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potofs: []\n      stats: []\n      cards: []\n      parts: []\n      phases: []\n\n  test 'get api/books/:book_id/chats', (t)->\n    { text } = await http\n    .get \"/api/books/test-1/chats\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      chats: []\n","check = ->\n  potof:\n    face_id: \"sf10\"\n    job: \"保安技師\"\n    sign: '公開サイン'\n  \n  part:\n    _id: \"test-1-1\"\n    idx: \"1\"\n    label: \"一日目\"\n\nmodule.exports = (app, { test, http, bless })->\n  test 'post api/books/test-1/potof.', (t)->\n    await http.post \"/test/session\"\n\n    { potof } = check()\n    { text } = await http\n    .post \"/api/books/test-1/potof\"\n    .type 'json'\n    .send { potof, phase_id: 'test-1-1-SSAY' }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      stat:\n        idx: 'SSAY'\n        give: 0\n        sw: false\n      card:\n        idx: 'request'\n        role_id: null\n      chat: {}\n      potof\n"],"sourceRoot":""}