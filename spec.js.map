{"version":3,"sources":["webpack:///webpack/bootstrap 20f74ade90f0841a9ead","webpack:///external \"child_process\"","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///./api/base.coffee","webpack:///./api/mongodb.coffee","webpack:///external \"express\"","webpack:///external \"body-parser\"","webpack:///external \"mongodb-bluebird\"","webpack:///external \"morgan\"","webpack:///./spec/book.coffee","webpack:///./spec/chat.coffee","webpack:///./spec/user.coffee","webpack:///external \"ava\"","webpack:///external \"js-yaml\"","webpack:///external \"mongoose\"","webpack:///external \"supertest\"","webpack:///./spec/index.coffee"],"names":[],"mappings":"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","file":"spec.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 22);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 20f74ade90f0841a9ead","module.exports = require(\"child_process\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"child_process\"\n// module id = 0\n// module chunks = 0 1","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 1\n// module chunks = 0 1","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 2\n// module chunks = 0 1","bodyParser = require 'body-parser'\nlogger = require 'morgan'\n\nmodule.exports = (app, conf)->\n  app.use logger 'dev'\n  app.use bodyParser.json()\n  app.use (req, res, next)->\n    res.header \"Access-Control-Allow-Origin\", \"*\"\n    res.header \"Access-Control-Allow-Headers\", \"Origin, X-Requested-With, Content-Type, Accept\"\n    next()\n\n\n\n// WEBPACK FOOTER //\n// ./api/base.coffee","mongo = require \"mongodb-bluebird\"\nsh = require 'child_process'\nfs = require 'fs'\n_ = require \"lodash\"\n\nObjectId = false\n\ngiji = {}\n\nmodule.exports = (app, { url, db })->\n  return unless db.mongo_sow\n  mongo.connect db.mongo_sow\n  .then (db)->\n    end = (err, o)->\n      console.log err, o\n    giji.find = (id, query, projection)->\n      db.collection id, {ObjectId}\n      .find query, projection\n\n    giji.aggregate_message = ->\n      cmd = (out, keys, ext...)->\n        db.collection(\"message_by_story_for_face\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$date_min\"\n            date_max:\n              $max: \"$date_max\"\n            max:\n              $max: \"$max\"\n            all:\n              $sum: \"$all\"\n            count:\n              $sum: \"$count\"\n            story_ids:\n              $addToSet: \"$_id.story_id\"\n        ,\n          $out: out\n        ], {ObjectId}\n\n      Promise.all [\n        cmd \"message_for_face\",\n          face_id: \"$_id.face_id\"\n        cmd \"message_for_face_sow_auth\",\n          face_id:     \"$_id.face_id\"\n          sow_auth_id: \"$_id.sow_auth_id\"\n        cmd \"message_for_face_mestype\",\n          face_id: \"$_id.face_id\"\n          mestype: \"$_id.mestype\"\n      ]\n\n\n    giji.aggregate_potof = ->\n      cmd = (out, keys, ext...)->\n        db.collection(\"potofs\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $match:\n            sow_auth_id:\n              $exists: 1\n              $nin: [null, \"master\", \"admin\"]\n            face_id:\n              $exists: 1\n              $ne: null\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$timer.entrieddt\"\n            date_max:\n              $max: \"$timer.entrieddt\"\n            story_ids:\n              $addToSet: \"$story_id\"\n\n        ,\n          $out: out\n        ], {ObjectId}\n\n      Promise.all [\n        cmd \"potof_for_face\",\n          face_id: \"$face_id\"\n        cmd \"potof_for_face_live\",\n          face_id: \"$face_id\"\n          live: \"$live\"\n        cmd \"potof_for_face_sow_auth\",\n          face_id:     \"$face_id\"\n          sow_auth_id: \"$sow_auth_id\"\n        cmd \"potof_for_face_role\",\n          face_id: \"$face_id\"\n          role_id: \"$role\"\n        ,\n          $unwind: \"$role\"\n      ]\n\n    giji.aggregate_max = ->\n      db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).remove({})\n      .then ->\n        db.collection(\"potof_for_face_sow_auth\", { ObjectId }).aggregate [\n          $project:\n            _id: 1\n            count:\n              $size: \"$story_ids\"\n        ,\n          $group:\n            _id:\n              face_id: \"$_id.face_id\"\n            count:\n              $max: \"$count\"\n        ], {ObjectId}\n      .then (data)->\n        Promise.all data.map (o)->\n          giji.find \"potof_for_face_sow_auth\",\n            \"_id.face_id\": o._id.face_id\n            story_ids:\n              $size: o.count\n          .then (list)->\n            [top] = _.sortBy list, (a)-> a.date_min\n            o.date_min = top.date_min\n            o.date_max = top.date_max\n            o._id      = top._id\n            o\n      .then (data)->\n        db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).insert data\n\n    giji.oldlog = ->\n      db.collection(\"stories\", { ObjectId }).aggregate [\n        $match:\n          is_finish:\n            $eq: true\n      ,\n        $project:\n          _id: 1\n      ,\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id\"\n      ], {ObjectId}\n      .then ([o])->\n        data = for id in o.story_ids\n          dst = \"./static/sow/#{id}.json.gz\"\n          src = \"#{url.api}/story/oldlog/#{id}\"\n          \"\"\"  ls \"#{dst}\" || curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/sow/index.json.gz\"\n        src = \"#{url.api}/story/oldlog\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/aggregate/faces/index.json.gz\"\n        src = \"#{url.api}/aggregate/faces\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        data.push \"\"\" npm run gulp amazon:gz \"\"\"\n\n        fs.writeFile './static/sow.sh', data.join(\"\\n\") , (err)->\n          console.log err\n        false\n\n    giji.scan = ->\n      db.collection(\"message_by_story_for_face\", { ObjectId }).aggregate [\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id.story_id\"\n      ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        db.collection(\"stories\", { ObjectId }).aggregate [\n          $match:\n            _id:\n              $nin: list\n            is_finish:\n              $eq: true\n        ,\n          $project:\n            _id: 1\n        ,\n          $group:\n            _id: null\n            story_ids:\n              $addToSet: \"$_id\"\n        ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        console.log \"step B\"\n        console.log list\n        set_bases = for id in list\n          giji.set_base id\n        Promise.all set_bases\n\n    giji.set_base = (story_id)->\n      db.collection(\"messages\", { ObjectId }).aggregate [\n        $match:\n          story_id: story_id\n          sow_auth_id:\n            $exists: 1\n            $ne: null\n          face_id:\n            $exists: 1\n            $ne: null\n          logid:\n            $exists: 1\n            $ne: null\n          log:\n            $exists: 1\n            $ne: null\n      ,\n        $project:\n          sow_auth_id: 1\n          story_id: 1\n          face_id: 1\n          logid: 1\n          date: 1\n          size:\n            $strLenCP: \"$log\"\n      ,\n        $group:\n          _id:\n            sow_auth_id: \"$sow_auth_id\"\n            story_id: \"$story_id\"\n            face_id: \"$face_id\"\n            mestype:\n              $substr: [\"$logid\", 0, 2]\n          date_min:\n            $min: \"$date\"\n          date_max:\n            $max: \"$date\"\n          max:\n            $max: \"$size\"\n          all:\n            $sum: \"$size\"\n          count:\n            $sum: 1\n      ], {ObjectId}\n      .then (data)->\n        db.collection(\"message_by_story_for_face\").insert data\n\n  .catch ->\n    console.log \"!!! mongodb connect error !!!\"\n\n\n  app.get '/api/aggregate/job', (req, res, next)->\n    giji.scan()\n    .then ->\n      giji.aggregate_message()\n    .then ->\n      giji.aggregate_potof()\n    .then ->\n      giji.aggregate_max()\n    .then ->\n      giji.oldlog()\n    .then ->\n      res.json\n        started: true\n      next()\n    .catch (e)->\n      res.json e\n      next()\n\n  app.get '/api/aggregate/faces', (req, res, next)->\n    q = {}\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_sow_auth_max\", q\n    ]\n    .then ([m_faces, faces, sow_auths])->\n      res.json { m_faces, faces, sow_auths }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/aggregate/faces/:id', (req, res, next)->\n    { id } = req.params\n    q =\n      \"_id.face_id\": id\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"message_for_face_mestype\", q\n      giji.find \"message_for_face_sow_auth\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_role\", q\n      giji.find \"potof_for_face_live\", q\n    ]\n    .then ([m_faces, mestypes, sow_auths, faces, roles, lives])->\n      res.json { m_faces, mestypes, sow_auths, faces, roles, lives }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/progress', (req, res, next)->\n    q =\n      is_epilogue: false\n      is_finish: false\n    fields =\n      comment:  0\n      password: 0\n    json = {}\n    giji.find \"stories\", q, fields\n    .then (data)->\n      json.stories = data\n      data.map (o)-> \"#{o._id}-0\"\n    .then (ids)->\n      giji.find \"events\",\n        _id:\n          $in: ids\n    .then (data)->\n      json.events = data\n    .then ->\n      res.json json\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog', (req, res, next)->\n    q =\n      is_epilogue: true\n      is_finish:   true\n    fields =\n      comment:  0\n      password: 0\n    Promise.all [\n      giji.find \"stories\", q, fields\n      giji.find \"potof_for_face\", {}\n    ]\n    .then ([stories, faces])->\n      res.json { stories, faces }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog/:story_id', (req, res, next)->\n    { story_id } = req.params\n    fields =\n      password: 0\n    Promise.all [\n      giji.find \"stories\",  { _id: story_id, is_epilogue: true, is_finish: true}, fields\n      giji.find \"messages\", { story_id }\n      giji.find \"events\",   { story_id }\n      giji.find \"potofs\",   { story_id }\n    ]\n    .then ([stories, messages, events, potofs])->\n      unless stories.length\n        messages = events = potofs = []\n      res.json { stories, messages, events, potofs }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  return\n\n\n\n// WEBPACK FOOTER //\n// ./api/mongodb.coffee","module.exports = require(\"express\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express\"\n// module id = 5\n// module chunks = 0 1","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 6\n// module chunks = 0 1","module.exports = require(\"mongodb-bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongodb-bluebird\"\n// module id = 7\n// module chunks = 0 1","module.exports = require(\"morgan\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"morgan\"\n// module id = 8\n// module chunks = 0 1","check = ->\n  book:\n    label: \"testcase\"\n    chat:\n      interval: \"1d\"\n      night:    \"0\"\n      player: 4\n      mob:    0\n    game:\n      vote: \"sign\"\n      vote_by: [\"live\"]\n    tag_ids: [\"god\", \"travel\"]\n    option: [\"vote_by_live\"]\n\n  potof:\n    _id: \"test-1-NPC\"\n    face_id: \"sf10\"\n    job: \"保安技師\"\n    sign: '公開サイン'\n  \n  chats: [\n    idx: \"welcome\"\n  ,\n    idx: \"vrule\"\n    log: \"\"\"\n1. 多重ログインをしない。\n2. システムの出力内容を、そのまま書き写さない。\n3. エピローグまで秘密を守る。参加中の村の内容は秘密だ。\n4. エピローグまで秘密を守る。希望した能力、画面を見ているきみが何者なのかは秘密だ。\n      \"\"\"\n  ]\n\n  part:\n    _id: \"test-1-1\"\n    idx: \"1\"\n    label: \"一日目\"\n\nmodule.exports = (app, { test, http, bless })->\n  test.serial 'post api/books', (t)->\n    await http.post \"/test/session\"\n\n    { book, potof } = check()\n    { text } = await http\n    .post \"/api/books\"\n    .type 'json'\n    .send { book, potof }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potof:\n        idx: \"NPC\"\n        face_id: \"sf10\"\n\n        job: \"保安技師\"\n        sign: \"公開サイン\"\n      part:\n        idx: \"0\"\n        label: \"プロローグ\"\n      phases: [\n        idx: \"BM\"\n        handle: \"MAKER\"\n        update: true\n      ,\n        idx: \"MM\"\n        handle: \"SSAY\"\n        update: true\n      ,\n        idx: \"TM\"\n        handle: \"private\"\n        update: false\n      ,\n        idx: \"SM\"\n        handle: \"public\"\n        update: false\n      ,\n        idx: \"TS\"\n        handle: \"TSAY\"\n        update: false\n      ,\n        idx: \"Aim\"\n        handle: \"AIM\"\n        update: false\n      ,\n        idx: \"SS\"\n        handle: \"SSAY\"\n        update: false\n      ,\n        idx: \"VS\"\n        handle: \"VSAY\"\n        update: false\n      ]\n      chats: [\n        idx: \"welcome\"\n      ,\n        idx: \"nrule\"\n      ,\n        idx: \"vrule\"\n      ,\n        idx: \"0\"\n      ]\n\n\n  test 'post api/books/:book_id', (t)->\n    { book, potof } = check()\n\n    { text } = await http\n    .post \"/api/books/test-1\"\n    .type 'json'\n    .send { book, potof }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potof: check().potof\n      phases: [\n        _id: \"test-1-0-BM\"\n        idx: \"BM\"\n      ,\n        _id: \"test-1-0-MM\"\n        idx: \"MM\"\n      ]\n      chats: [\n        _id: \"test-1-0-BM-welcome\"\n        idx: \"welcome\"\n      ,\n        _id: \"test-1-0-BM-nrule\"\n        idx: \"nrule\"\n      ,\n        _id: \"test-1-0-BM-vrule\"\n        idx: \"vrule\"\n      ]\n\n  test 'post api/books/:book_id/part', (t)->\n    { part } = check()\n\n    { text } = await http\n    .post \"/api/books/test-1/part\"\n    .type 'json'\n    .send { part }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      part: check().part\n      phases: [\n        idx: \"TM\"\n        handle: \"private\"\n        update: false\n      ,\n        idx: \"SM\"\n        handle: \"public\"\n        update: false\n      ,\n        idx: \"TS\"\n        handle: \"TSAY\"\n        update: false\n      ,\n        idx: \"Aim\"\n        handle: \"AIM\"\n        update: false\n      ,\n        idx: \"SS\"\n        handle: \"SSAY\"\n        update: false\n      ,\n        idx: \"VS\"\n        handle: \"VSAY\"\n        update: false\n      ]\n      chats: [\n        idx: \"0\"\n      ]\n\n\n  test 'get api/books', (t)->\n    { text } = await http\n    .get \"/api/books\"\n\n    bless t\n    for book in JSON.parse(text).books\n      t.deepContain book, check().book\n\n  test 'get api/books/:book_id', (t)->\n    { text } = await http\n    .get \"/api/books/test-1\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potofs: []\n      stats: []\n      cards: []\n      parts: []\n      phases: []\n\n  test 'get api/books/:book_id/chats', (t)->\n    { text } = await http\n    .get \"/api/books/test-1/chats\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      chats: []\n\n\n\n// WEBPACK FOOTER //\n// ./spec/book.coffee","check = ->\n  potof:\n    face_id: \"sf10\"\n    job: \"保安技師\"\n    sign: '公開サイン'\n  \n  part:\n    _id: \"test-1-1\"\n    idx: \"1\"\n    label: \"一日目\"\n\nmodule.exports = (app, { test, http, bless })->\n  test 'post api/books/test-1/potof.', (t)->\n    await http.post \"/test/session\"\n\n    { potof } = check()\n    { text } = await http\n    .post \"/api/books/test-1/potof\"\n    .type 'json'\n    .send { potof, phase_id: 'test-1-1-SSAY' }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      stat:\n        idx: 'SSAY'\n        give: 0\n        sw: false\n      card:\n        idx: 'request'\n        role_id: null\n      chat: {}\n      potof\n\n\n\n// WEBPACK FOOTER //\n// ./spec/chat.coffee","user =\n  sign: \"公開サイン\"\n\nmodule.exports = (app, { test, http, bless })->\n  test.serial 'post api/user fail.', (t)->\n    await http.post \"/logout\"\n\n    { text } = await http\n    .post \"/api/user\"\n    .send\n      user:\n        sign: \"公開サイン\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      message: \"ログインしていません。\"\n\n  test.serial 'post api/user', (t)->\n    await http.post \"/test/session\"\n\n    { text } = await http\n    .post \"/api/user\"\n    .send { user }\n\n    bless t\n    t.deepContain JSON.parse(text), { user }\n\n  test 'get /auth/google/callback.', (t)->\n    { redirect, header: { location } } = await http.get \"/auth/google/callback\"\n\n    bless t\n    t.is redirect, true\n    t.match location, ///\n      https://accounts.google.com/o/oauth2/v2/auth\\?response_type=code&redirect_uri=http%3A%2F%2F127.0.0.1%3A\\d\\d\\d\\d\\d%2Fauth%2Fgoogle%2Fundefined%2Fauth%2Fgoogle%2Fcallback&client_id=TEST-CLIENT-ID\n    ///\n\n  test 'get /auth/facebook/callback.', (t)->\n    { redirect, header: { location } } = await http.get \"/auth/facebook/callback\"\n    \n    bless t\n    t.is redirect, true\n    t.match location, ///\n      https://www.facebook.com/dialog/oauth\\?response_type=code&redirect_uri=http%3A%2F%2F127.0.0.1%3A\\d\\d\\d\\d\\d%2Fauth%2Ffacebook%2Fundefined%2Fauth%2Ffacebook%2Fcallback&client_id=TEST-CLIENT-ID\n    ///\n\n\n\n// WEBPACK FOOTER //\n// ./spec/user.coffee","module.exports = require(\"ava\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"ava\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"js-yaml\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"js-yaml\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"mongoose\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongoose\"\n// module id = 17\n// module chunks = 0","module.exports = require(\"supertest\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"supertest\"\n// module id = 18\n// module chunks = 0","test = require 'ava'\nexpress = require 'express'\nmongoose = require \"mongoose\"\nsupertest = require 'supertest'\n\nfs = require 'fs'\nyaml = require 'js-yaml'\n\n\nconf = yaml.load fs.readFileSync \"./config/spec.yml\", 'UTF-8'\n\nuser =\n  _id: \"local-test-user\"\n  provider: \"local-test\"\n  icon: \"https://s3-ap-northeast-1.amazonaws.com/giji-assets/images/portrate/w52.jpg\"\n  mail: \"7korobi.sys@gmail.com\"\n  nick: \"テスト中\"\n  sign: \"SIGN.SPEC\"\n  write_at: new Date - 0\n  token: \"DEADBEEF\"\n  account: \"user\"\n\n_ = require \"lodash\"\nbless = (t)->\n  t.match = (tgt, chk)->\n    result = [ tgt ]\n    result.index = 0\n    result.input = tgt\n    @deepEqual result, tgt.match chk\n\n  t.deepContain = (tgt, chk)->\n    chk = _.mergeWith chk, tgt, (c, o)->\n      switch c?.constructor\n        when null, undefined\n          o\n        when Array, Object\n          undefined\n        else\n          c\n    @deepEqual tgt, chk\n\napp = express()\nrequire(\"~/api/base\"    )(app, conf)\nrequire(\"~/api/mongodb\" )(app, conf)\n\napp.post '/test/session', (req, res, next)->\n  req.session.passport ?= {}\n  req.session.passport.user ?= user\n  res.json req.session.passport\n\nhttp = supertest.agent(app)\n\n\nrequire(\"~/spec/user\") app, { test, bless, http }\nrequire(\"~/spec/book\") app, { test, bless, http }\nrequire(\"~/spec/chat\") app, { test, bless, http }\n\n\n\n// WEBPACK FOOTER //\n// ./spec/index.coffee"],"sourceRoot":""}