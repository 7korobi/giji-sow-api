{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"lodash\"","webpack:///external \"fs\"","webpack:///external \"child_process\"","webpack:///external \"mongodb-bluebird\"","webpack:///./api/mongodb.coffee","webpack:///external \"morgan\"","webpack:///external \"body-parser\"","webpack:///./api/base.coffee","webpack:///external \"express\"","webpack:///./spec/chat.coffee","webpack:///./spec/book.coffee","webpack:///./spec/user.coffee","webpack:///external \"js-yaml\"","webpack:///external \"supertest\"","webpack:///external \"ava\"","webpack:///./spec/index.coffee"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","_","fs","giji","mongo","sh","app","url","db","mongo_sow","connect","then","err","console","log","find","id","query","projection","collection","ObjectId","aggregate_message","cmd","out","keys","ext","aggregate","$group","_id","date_min","$min","date_max","$max","max","all","$sum","count","story_ids","$addToSet","$out","Promise","face_id","sow_auth_id","mestype","aggregate_potof","$match","$exists","$nin","$ne","live","role_id","$unwind","aggregate_max","remove","$project","$size","data","map","_id.face_id","list","top","sortBy","a","insert","oldlog","is_finish","$eq","dst","src","results","len","ref","length","api","push","writeFile","join","chmod","scan","set_bases","set_base","story_id","logid","date","size","$strLenCP","$substr","catch","req","res","next","exec","stdout","stderr","error","json","started","e","q","m_faces","faces","sow_auths","params","mestypes","roles","lives","fields","is_epilogue","comment","password","stories","ids","$in","events","messages","potofs","bodyParser","logger","conf","use","header","test","http","bless","async","potof","text","post","job","sign","part","idx","label","type","send","phase_id","deepContain","JSON","parse","stat","give","sw","card","chat","serial","book","interval","night","player","mob","game","vote","vote_by","tag_ids","option","chats","phases","handle","update","books","stats","cards","parts","user","message","location","redirect","is","match","express","supertest","load","readFileSync","provider","icon","mail","nick","write_at","Date","token","account","tgt","chk","result","index","input","this","deepEqual","mergeWith","constructor","Array","base","base1","passport","session","agent"],"mappings":"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","file":"spec.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 15);\n","module.exports = require(\"lodash\");","module.exports = require(\"fs\");","module.exports = require(\"child_process\");","module.exports = require(\"mongodb-bluebird\");","mongo = require \"mongodb-bluebird\"\nsh = require 'child_process'\nfs = require 'fs'\n_ = require \"lodash\"\n\nObjectId = false\n\ngiji = {}\n\nmodule.exports = (app, { url, db })->\n  return unless db.mongo_sow\n  mongo.connect db.mongo_sow\n  .then (db)->\n    end = (err, o)->\n      console.log err, o\n    giji.find = (id, query, projection)->\n      db.collection id, {ObjectId}\n      .find query, projection\n\n    giji.aggregate_message = ->\n      cmd = (out, keys, ext...)->\n        db.collection(\"message_by_story_for_face\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$date_min\"\n            date_max:\n              $max: \"$date_max\"\n            max:\n              $max: \"$max\"\n            all:\n              $sum: \"$all\"\n            count:\n              $sum: \"$count\"\n            story_ids:\n              $addToSet: \"$_id.story_id\"\n        ,\n          $out: out\n        ], {ObjectId}\n\n      Promise.all [\n        cmd \"message_for_face\",\n          face_id: \"$_id.face_id\"\n        cmd \"message_for_face_sow_auth\",\n          face_id:     \"$_id.face_id\"\n          sow_auth_id: \"$_id.sow_auth_id\"\n        cmd \"message_for_face_mestype\",\n          face_id: \"$_id.face_id\"\n          mestype: \"$_id.mestype\"\n      ]\n\n\n    giji.aggregate_potof = ->\n      cmd = (out, keys, ext...)->\n        db.collection(\"potofs\", {ObjectId}).aggregate [\n          ext...\n        ,\n          $match:\n            sow_auth_id:\n              $exists: 1\n              $nin: [null, \"master\", \"admin\"]\n            face_id:\n              $exists: 1\n              $ne: null\n        ,\n          $group:\n            _id: keys\n            date_min:\n              $min: \"$timer.entrieddt\"\n            date_max:\n              $max: \"$timer.entrieddt\"\n            story_ids:\n              $addToSet: \"$story_id\"\n\n        ,\n          $out: out\n        ], {ObjectId}\n\n      Promise.all [\n        cmd \"potof_for_face\",\n          face_id: \"$face_id\"\n        cmd \"potof_for_face_live\",\n          face_id: \"$face_id\"\n          live: \"$live\"\n        cmd \"potof_for_face_sow_auth\",\n          face_id:     \"$face_id\"\n          sow_auth_id: \"$sow_auth_id\"\n        cmd \"potof_for_face_role\",\n          face_id: \"$face_id\"\n          role_id: \"$role\"\n        ,\n          $unwind: \"$role\"\n      ]\n\n    giji.aggregate_max = ->\n      db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).remove({})\n      .then ->\n        db.collection(\"potof_for_face_sow_auth\", { ObjectId }).aggregate [\n          $project:\n            _id: 1\n            count:\n              $size: \"$story_ids\"\n        ,\n          $group:\n            _id:\n              face_id: \"$_id.face_id\"\n            count:\n              $max: \"$count\"\n        ], {ObjectId}\n      .then (data)->\n        Promise.all data.map (o)->\n          giji.find \"potof_for_face_sow_auth\",\n            \"_id.face_id\": o._id.face_id\n            story_ids:\n              $size: o.count\n          .then (list)->\n            [top] = _.sortBy list, (a)-> a.date_min\n            o.date_min = top.date_min\n            o.date_max = top.date_max\n            o._id      = top._id\n            o\n      .then (data)->\n        db.collection(\"potof_for_face_sow_auth_max\", { ObjectId }).insert data\n\n    giji.oldlog = ->\n      db.collection(\"stories\", { ObjectId }).aggregate [\n        $match:\n          is_finish:\n            $eq: true\n      ,\n        $project:\n          _id: 1\n      ,\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id\"\n      ], {ObjectId}\n      .then ([o])->\n        data = for id in o.story_ids\n          dst = \"./static/sow/#{id}.json.gz\"\n          src = \"#{url.api}/story/oldlog/#{id}\"\n          \"\"\"  ls \"#{dst}\" || curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/sow/index.json.gz\"\n        src = \"#{url.api}/story/oldlog\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        dst = \"./static/aggregate/faces/index.json.gz\"\n        src = \"#{url.api}/aggregate/faces\"\n        data.push \"\"\" curl \"#{src}\" | gzip --stdout --best > \"#{dst}\"  \"\"\"\n\n        data.push \"\"\" npm run gulp amazon:gz \"\"\"\n\n        fs.writeFile './static/sow.sh', data.join(\"\\n\") , (err)->\n          fs.chmod './static/sow.sh', 0o777, (err)->\n        false\n\n    giji.scan = ->\n      db.collection(\"message_by_story_for_face\", { ObjectId }).aggregate [\n        $group:\n          _id: null\n          story_ids:\n            $addToSet: \"$_id.story_id\"\n      ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        db.collection(\"stories\", { ObjectId }).aggregate [\n          $match:\n            _id:\n              $nin: list\n            is_finish:\n              $eq: true\n        ,\n          $project:\n            _id: 1\n        ,\n          $group:\n            _id: null\n            story_ids:\n              $addToSet: \"$_id\"\n        ], {ObjectId}\n      .then ([o])->\n        list = o?.story_ids ? []\n        console.log \"step B\"\n        console.log list\n        set_bases = for id in list\n          giji.set_base id\n        Promise.all set_bases\n\n    giji.set_base = (story_id)->\n      db.collection(\"messages\", { ObjectId }).aggregate [\n        $match:\n          story_id: story_id\n          sow_auth_id:\n            $exists: 1\n            $ne: null\n          face_id:\n            $exists: 1\n            $ne: null\n          logid:\n            $exists: 1\n            $ne: null\n          log:\n            $exists: 1\n            $ne: null\n      ,\n        $project:\n          sow_auth_id: 1\n          story_id: 1\n          face_id: 1\n          logid: 1\n          date: 1\n          size:\n            $strLenCP: \"$log\"\n      ,\n        $group:\n          _id:\n            sow_auth_id: \"$sow_auth_id\"\n            story_id: \"$story_id\"\n            face_id: \"$face_id\"\n            mestype:\n              $substr: [\"$logid\", 0, 2]\n          date_min:\n            $min: \"$date\"\n          date_max:\n            $max: \"$date\"\n          max:\n            $max: \"$size\"\n          all:\n            $sum: \"$size\"\n          count:\n            $sum: 1\n      ], {ObjectId}\n      .then (data)->\n        db.collection(\"message_by_story_for_face\").insert data\n\n  .catch ->\n    console.log \"!!! mongodb connect error !!!\"\n\n\n  app.get '/api/aggregate/job', (req, res, next)->\n    giji.scan()\n    .then ->\n      giji.aggregate_message()\n    .then ->\n      giji.aggregate_potof()\n    .then ->\n      giji.aggregate_max()\n    .then ->\n      giji.oldlog()\n    .then ->\n      sh.exec \"./static/sow.sh\", (err, stdout, stderr)->\n        if err\n          console.error err\n        else\n          console.log stderr\n        res.json\n          started: ! err\n        next()\n    .catch (e)->\n      res.json e\n      next()\n\n  app.get '/api/aggregate/faces', (req, res, next)->\n    q = {}\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_sow_auth_max\", q\n    ]\n    .then ([m_faces, faces, sow_auths])->\n      res.json { m_faces, faces, sow_auths }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/aggregate/faces/:id', (req, res, next)->\n    { id } = req.params\n    q =\n      \"_id.face_id\": id\n    Promise.all [\n      giji.find \"message_for_face\", q\n      giji.find \"message_for_face_mestype\", q\n      giji.find \"message_for_face_sow_auth\", q\n      giji.find \"potof_for_face\", q\n      giji.find \"potof_for_face_role\", q\n      giji.find \"potof_for_face_live\", q\n    ]\n    .then ([m_faces, mestypes, sow_auths, faces, roles, lives])->\n      res.json { m_faces, mestypes, sow_auths, faces, roles, lives }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/progress', (req, res, next)->\n    q =\n      is_epilogue: false\n      is_finish: false\n    fields =\n      comment:  0\n      password: 0\n    json = {}\n    giji.find \"stories\", q, fields\n    .then (data)->\n      json.stories = data\n      data.map (o)-> \"#{o._id}-0\"\n    .then (ids)->\n      giji.find \"events\",\n        _id:\n          $in: ids\n    .then (data)->\n      json.events = data\n    .then ->\n      res.json json\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog', (req, res, next)->\n    q =\n      is_epilogue: true\n      is_finish:   true\n    fields =\n      comment:  0\n      password: 0\n    Promise.all [\n      giji.find \"stories\", q, fields\n      giji.find \"potof_for_face\", {}\n    ]\n    .then ([stories, faces])->\n      res.json { stories, faces }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  app.get '/api/story/oldlog/:story_id', (req, res, next)->\n    { story_id } = req.params\n    fields =\n      password: 0\n    Promise.all [\n      giji.find \"stories\",  { _id: story_id, is_epilogue: true, is_finish: true}, fields\n      giji.find \"messages\", { story_id }\n      giji.find \"events\",   { story_id }\n      giji.find \"potofs\",   { story_id }\n    ]\n    .then ([stories, messages, events, potofs])->\n      unless stories.length\n        messages = events = potofs = []\n      res.json { stories, messages, events, potofs }\n      next()\n    .catch (e)->\n      console.error req, e\n      next()\n\n  return\n","module.exports = require(\"morgan\");","module.exports = require(\"body-parser\");","bodyParser = require 'body-parser'\nlogger = require 'morgan'\n\nmodule.exports = (app, conf)->\n  app.use logger 'dev'\n  app.use bodyParser.json()\n  app.use (req, res, next)->\n    res.header \"Access-Control-Allow-Origin\", \"*\"\n    res.header \"Access-Control-Allow-Headers\", \"Origin, X-Requested-With, Content-Type, Accept\"\n    next()\n","module.exports = require(\"express\");","check = ->\n  potof:\n    face_id: \"sf10\"\n    job: \"保安技師\"\n    sign: '公開サイン'\n  \n  part:\n    _id: \"test-1-1\"\n    idx: \"1\"\n    label: \"一日目\"\n\nmodule.exports = (app, { test, http, bless })->\n  test 'post api/books/test-1/potof.', (t)->\n    await http.post \"/test/session\"\n\n    { potof } = check()\n    { text } = await http\n    .post \"/api/books/test-1/potof\"\n    .type 'json'\n    .send { potof, phase_id: 'test-1-1-SSAY' }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      stat:\n        idx: 'SSAY'\n        give: 0\n        sw: false\n      card:\n        idx: 'request'\n        role_id: null\n      chat: {}\n      potof\n","check = ->\n  book:\n    label: \"testcase\"\n    chat:\n      interval: \"1d\"\n      night:    \"0\"\n      player: 4\n      mob:    0\n    game:\n      vote: \"sign\"\n      vote_by: [\"live\"]\n    tag_ids: [\"god\", \"travel\"]\n    option: [\"vote_by_live\"]\n\n  potof:\n    _id: \"test-1-NPC\"\n    face_id: \"sf10\"\n    job: \"保安技師\"\n    sign: '公開サイン'\n  \n  chats: [\n    idx: \"welcome\"\n  ,\n    idx: \"vrule\"\n    log: \"\"\"\n1. 多重ログインをしない。\n2. システムの出力内容を、そのまま書き写さない。\n3. エピローグまで秘密を守る。参加中の村の内容は秘密だ。\n4. エピローグまで秘密を守る。希望した能力、画面を見ているきみが何者なのかは秘密だ。\n      \"\"\"\n  ]\n\n  part:\n    _id: \"test-1-1\"\n    idx: \"1\"\n    label: \"一日目\"\n\nmodule.exports = (app, { test, http, bless })->\n  test.serial 'post api/books', (t)->\n    await http.post \"/test/session\"\n\n    { book, potof } = check()\n    { text } = await http\n    .post \"/api/books\"\n    .type 'json'\n    .send { book, potof }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potof:\n        idx: \"NPC\"\n        face_id: \"sf10\"\n\n        job: \"保安技師\"\n        sign: \"公開サイン\"\n      part:\n        idx: \"0\"\n        label: \"プロローグ\"\n      phases: [\n        idx: \"BM\"\n        handle: \"MAKER\"\n        update: true\n      ,\n        idx: \"MM\"\n        handle: \"SSAY\"\n        update: true\n      ,\n        idx: \"TM\"\n        handle: \"private\"\n        update: false\n      ,\n        idx: \"SM\"\n        handle: \"public\"\n        update: false\n      ,\n        idx: \"TS\"\n        handle: \"TSAY\"\n        update: false\n      ,\n        idx: \"Aim\"\n        handle: \"AIM\"\n        update: false\n      ,\n        idx: \"SS\"\n        handle: \"SSAY\"\n        update: false\n      ,\n        idx: \"VS\"\n        handle: \"VSAY\"\n        update: false\n      ]\n      chats: [\n        idx: \"welcome\"\n      ,\n        idx: \"nrule\"\n      ,\n        idx: \"vrule\"\n      ,\n        idx: \"0\"\n      ]\n\n\n  test 'post api/books/:book_id', (t)->\n    { book, potof } = check()\n\n    { text } = await http\n    .post \"/api/books/test-1\"\n    .type 'json'\n    .send { book, potof }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potof: check().potof\n      phases: [\n        _id: \"test-1-0-BM\"\n        idx: \"BM\"\n      ,\n        _id: \"test-1-0-MM\"\n        idx: \"MM\"\n      ]\n      chats: [\n        _id: \"test-1-0-BM-welcome\"\n        idx: \"welcome\"\n      ,\n        _id: \"test-1-0-BM-nrule\"\n        idx: \"nrule\"\n      ,\n        _id: \"test-1-0-BM-vrule\"\n        idx: \"vrule\"\n      ]\n\n  test 'post api/books/:book_id/part', (t)->\n    { part } = check()\n\n    { text } = await http\n    .post \"/api/books/test-1/part\"\n    .type 'json'\n    .send { part }\n\n    bless t\n    t.deepContain JSON.parse(text),\n      part: check().part\n      phases: [\n        idx: \"TM\"\n        handle: \"private\"\n        update: false\n      ,\n        idx: \"SM\"\n        handle: \"public\"\n        update: false\n      ,\n        idx: \"TS\"\n        handle: \"TSAY\"\n        update: false\n      ,\n        idx: \"Aim\"\n        handle: \"AIM\"\n        update: false\n      ,\n        idx: \"SS\"\n        handle: \"SSAY\"\n        update: false\n      ,\n        idx: \"VS\"\n        handle: \"VSAY\"\n        update: false\n      ]\n      chats: [\n        idx: \"0\"\n      ]\n\n\n  test 'get api/books', (t)->\n    { text } = await http\n    .get \"/api/books\"\n\n    bless t\n    for book in JSON.parse(text).books\n      t.deepContain book, check().book\n\n  test 'get api/books/:book_id', (t)->\n    { text } = await http\n    .get \"/api/books/test-1\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      book: check().book\n      potofs: []\n      stats: []\n      cards: []\n      parts: []\n      phases: []\n\n  test 'get api/books/:book_id/chats', (t)->\n    { text } = await http\n    .get \"/api/books/test-1/chats\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      chats: []\n","user =\n  sign: \"公開サイン\"\n\nmodule.exports = (app, { test, http, bless })->\n  test.serial 'post api/user fail.', (t)->\n    await http.post \"/logout\"\n\n    { text } = await http\n    .post \"/api/user\"\n    .send\n      user:\n        sign: \"公開サイン\"\n\n    bless t\n    t.deepContain JSON.parse(text),\n      message: \"ログインしていません。\"\n\n  test.serial 'post api/user', (t)->\n    await http.post \"/test/session\"\n\n    { text } = await http\n    .post \"/api/user\"\n    .send { user }\n\n    bless t\n    t.deepContain JSON.parse(text), { user }\n\n  test 'get /auth/google/callback.', (t)->\n    { redirect, header: { location } } = await http.get \"/auth/google/callback\"\n\n    bless t\n    t.is redirect, true\n    t.match location, ///\n      https://accounts.google.com/o/oauth2/v2/auth\\?response_type=code&redirect_uri=http%3A%2F%2F127.0.0.1%3A\\d\\d\\d\\d\\d%2Fauth%2Fgoogle%2Fundefined%2Fauth%2Fgoogle%2Fcallback&client_id=TEST-CLIENT-ID\n    ///\n\n  test 'get /auth/facebook/callback.', (t)->\n    { redirect, header: { location } } = await http.get \"/auth/facebook/callback\"\n    \n    bless t\n    t.is redirect, true\n    t.match location, ///\n      https://www.facebook.com/dialog/oauth\\?response_type=code&redirect_uri=http%3A%2F%2F127.0.0.1%3A\\d\\d\\d\\d\\d%2Fauth%2Ffacebook%2Fundefined%2Fauth%2Ffacebook%2Fcallback&client_id=TEST-CLIENT-ID\n    ///\n","module.exports = require(\"js-yaml\");","module.exports = require(\"supertest\");","module.exports = require(\"ava\");","test = require 'ava'\nexpress = require 'express'\nsupertest = require 'supertest'\n\nfs = require 'fs'\nyaml = require 'js-yaml'\n\n\nconf = yaml.load fs.readFileSync \"./config/spec.yml\", 'UTF-8'\n\nuser =\n  _id: \"local-test-user\"\n  provider: \"local-test\"\n  icon: \"https://s3-ap-northeast-1.amazonaws.com/giji-assets/images/portrate/w52.jpg\"\n  mail: \"7korobi.sys@gmail.com\"\n  nick: \"テスト中\"\n  sign: \"SIGN.SPEC\"\n  write_at: new Date - 0\n  token: \"DEADBEEF\"\n  account: \"user\"\n\n_ = require \"lodash\"\nbless = (t)->\n  t.match = (tgt, chk)->\n    result = [ tgt ]\n    result.index = 0\n    result.input = tgt\n    @deepEqual result, tgt.match chk\n\n  t.deepContain = (tgt, chk)->\n    chk = _.mergeWith chk, tgt, (c, o)->\n      switch c?.constructor\n        when null, undefined\n          o\n        when Array, Object\n          undefined\n        else\n          c\n    @deepEqual tgt, chk\n\napp = express()\nrequire(\"~/api/base\"    )(app, conf)\nrequire(\"~/api/mongodb\" )(app, conf)\n\napp.post '/test/session', (req, res, next)->\n  req.session.passport ?= {}\n  req.session.passport.user ?= user\n  res.json req.session.passport\n\nhttp = supertest.agent(app)\n\n\nrequire(\"~/spec/user\") app, { test, bless, http }\nrequire(\"~/spec/book\") app, { test, bless, http }\nrequire(\"~/spec/chat\") app, { test, bless, http }\n"],"sourceRoot":""}